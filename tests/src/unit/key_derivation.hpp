// key_derivation.hpp

// Copyright (c) Mateusz Jandura. All rights reserved.
// SPDX-License-Identifier: Apache-2.0

#pragma once
#ifndef _EFC_TEST_UNIT_KEY_DERIVATION_HPP_
#define _EFC_TEST_UNIT_KEY_DERIVATION_HPP_
#include <efc/key_derivation.hpp>
#include <gtest/gtest.h>

namespace mjx {
    namespace test {
        inline void _Run_key_derivation_test(
            const unicode_string_view _Password, const salt& _Salt, const char* const _Expected_key) noexcept {
            const key& _Key = derive_key(_Password, _Salt);
            EXPECT_EQ(::memcmp(_Key.data(), _Expected_key, key::size), 0);
        }

        inline salt _Make_salt(const char* const _Bytes) noexcept {
            salt _Salt;
            _Salt.assign(reinterpret_cast<const byte_t*>(_Bytes));
            return _Salt;
        }

        TEST(key_derivation, empty) {
            _Run_key_derivation_test(
                L"",
                _Make_salt("\xB1\xAA\x3E\xD8\xDB\xB4\xB0\x2F\x00\x37\x8F\x37\xF2\xDA\x1B\xB6"),
                "\xB4\x84\x0B\x49\x88\x09\x62\x3A\x9D\x30\x2F\xC9\x95\xC7\x08\x1D"
                "\x41\xDB\x1B\x38\x7C\xD4\x19\x46\xDA\x45\x13\xA6\x02\x92\x33\x27"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\x0C\x6D\xE1\xD9\xA2\x34\x68\x99\x9E\x30\xB4\xD1\xB1\x23\x2B\x18"),
                "\x30\x9E\xD2\xD0\x2B\x03\xE0\x32\xF6\xBB\x41\x0B\x62\xBF\x93\xBD"
                "\x6C\x23\x1F\x81\x9A\xC8\xC0\x00\x84\xEB\xE7\xDD\x45\x63\xB5\x00"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\x42\x20\x41\xCF\xAE\xD8\xDD\xC2\x20\x4C\x57\xF6\x49\x33\xA1\x01"),
                "\x3A\x96\x8E\x33\x2D\x4E\x84\x27\x0E\x78\x69\x4B\x69\xC1\x5F\x57"
                "\xA8\x04\x67\x1F\x35\x38\x47\x79\xC6\x43\x62\xB0\x37\x30\x5C\x5D"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\xD7\xAE\x1B\x8B\x82\xBF\xBE\x79\xDD\x1C\xFD\xED\x73\x79\xC3\xA7"),
                "\xCF\x2D\x5A\xA8\xF8\xB3\x41\xF4\xDF\xE9\x39\x5D\x40\x31\x9E\x67"
                "\x60\xEE\x4A\x0A\xFD\xD7\x69\xF6\xC9\xA7\x98\x08\xE0\xE8\x8D\x21"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\x2A\x61\xF5\xB8\xF5\x64\xAF\x53\x32\x4C\xAB\x67\x52\x66\x5C\xEB"),
                "\x27\x34\xA8\x01\xD8\x79\xD9\x87\x61\xC0\x00\x3F\xD2\x4D\x7B\xB9"
                "\x9D\x9B\x3F\xE5\xBD\xFE\xFA\xAB\x3E\x66\x45\xCF\xE9\xEF\x9E\xFC"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\x56\xA5\xBE\xF0\x73\x36\xF7\x9D\x27\x15\x00\x63\xA0\x0D\x6A\xB0"),
                "\x29\x2D\xE9\x66\xAE\x98\x50\x1B\x4B\xBE\xBD\xB6\xE3\x84\x13\xD9"
                "\x42\x45\xDA\xB5\xA4\xBE\xB2\xEB\xAA\xBE\xBC\xD1\x10\x29\x9F\xED"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\x9E\x8B\x71\xBA\x2F\xD3\xA0\x93\x55\xC9\x04\x38\x28\x23\x75\x1E"),
                "\xD9\x7A\x2D\x29\x29\x72\x59\xB4\x52\x73\x37\x9A\xF2\xD8\x68\x0A"
                "\x04\xAA\x87\xD9\x4A\x13\xAB\x20\x9A\xEA\xF0\xDB\xB4\x0D\xC2\x23"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\x94\xDF\x0C\x16\x70\x4C\x4D\xB2\xF8\xD5\x35\x15\xCB\x82\x0F\x95"),
                "\x4E\x76\x8A\x06\xA7\x1E\x13\xC6\x1F\x1C\x63\x09\x3E\xC4\xA6\x37"
                "\x86\x04\xB9\x07\xD4\x1C\x53\xB7\xE1\x19\xBD\x32\x5F\x71\x5A\xBB"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\x45\xC5\x7D\x89\xA9\x1B\xAA\xBA\x0E\xB3\x55\x73\x17\xBD\x22\xB1"),
                "\x17\xD0\x28\x1D\xC2\x72\x7B\xBA\x0A\xCB\x72\x88\x35\x0B\xA3\x3F"
                "\xA7\x07\x14\xD1\x66\x87\xEC\xB5\xA7\xEB\x6B\x38\x8F\xBF\x18\x1F"
            );
            _Run_key_derivation_test(
                L"",
                _Make_salt("\x99\xC4\x1B\x22\xD6\x44\x76\x9D\xF0\x76\xBB\xEF\x0E\xA7\x63\x48"),
                "\xB6\xED\x9F\x9D\xFD\x57\x14\xB6\x5C\xAC\xF3\x17\xD9\xF1\x03\xA6"
                "\xB3\x50\xE8\x8B\x4E\xCD\xC4\xE3\x5D\x1B\x37\x61\x15\xD5\x58\xD6"
            );
        }

        TEST(key_derivation, non_unicode) {
            _Run_key_derivation_test(
                L"The quick brown fox jumps.",
                _Make_salt("\xD6\xB9\xFF\x74\x60\x84\x6E\x9C\xB2\x66\x45\xE7\x2B\x6A\x08\x58"),
                "\x15\x93\x93\x19\x04\x39\x17\x77\x87\x96\xAC\xE7\x21\x28\xD9\x2A"
                "\x4D\xEE\x4A\x43\xEF\x07\x36\xD7\x8E\x9E\x94\x09\x4F\x06\x0D\x12"
            );
            _Run_key_derivation_test(
                L"Hello, world!",
                _Make_salt("\xFA\x47\xDA\xE8\xD5\x72\x33\x36\x44\x32\xAF\x2B\x89\xE4\xAF\x55"),
                "\x95\x5C\xAE\x6B\xC1\x78\x46\x80\xC0\xB7\xDE\x64\x1A\x80\xD9\x0C"
                "\xFE\x7A\xE1\x9C\x80\x15\x5B\xDE\xEC\xBE\xBA\x37\xE6\xD9\xFA\xC8"
            );
            _Run_key_derivation_test(
                L"I love programming.",
                _Make_salt("\xFF\xB2\x22\xE3\x79\x23\x80\x65\xD4\x85\xD2\x43\x05\x86\x88\x47"),
                "\x75\x02\x51\xEB\x94\x85\x6C\x17\x1C\x83\x97\x66\x96\xCA\x5D\x6B"
                "\x5E\xAE\xDD\xEB\xF2\x95\x8C\x0C\xB0\x1E\x53\x09\x43\x8F\xAD\xF2"
            );
            _Run_key_derivation_test(
                L"Bing is a search engine.",
                _Make_salt("\x4A\xAB\x6B\xB9\xFE\xC4\xC9\x06\xDC\x14\xDE\x25\xDC\xFD\x72\x7D"),
                "\xF6\x4A\x73\x94\x2D\x7A\x84\x63\xF8\x55\xDA\x22\xD5\x19\x4B\xEB"
                "\x89\x68\x6E\x70\x64\x22\xE8\x66\xB4\xEC\x68\x14\xBC\xD0\x14\xFC"
            );
            _Run_key_derivation_test(
                L"Python is a great language.",
                _Make_salt("\x0C\xD5\xFB\xBF\xF3\x60\x26\x92\xB6\x26\x32\x6E\x3D\xE3\xA6\x08"),
                "\xDA\x8F\xF5\x22\x58\x8F\xD0\xD0\x28\x29\x1A\x81\x6C\x2C\x17\x33"
                "\x77\xEE\xCE\x1C\x1F\x76\x21\x0F\x2D\x92\xB3\xFB\x51\x5E\x87\x50"
            );
            _Run_key_derivation_test(
                L"The sun rises in the east.",
                _Make_salt("\xD2\xFB\x83\xAA\xA7\x33\xA5\xAA\x0B\x5E\x77\x89\x8C\x42\xB4\xF2"),
                "\x8F\x2F\xBD\x7F\x68\x89\xFD\xC0\xDD\x3B\x6D\x1E\x53\x5C\x24\x4D"
                "\x76\x37\x44\xC5\x6F\xD1\xA7\x1C\x72\xBE\x2C\x2B\x95\x99\xB5\xE1"
            );
            _Run_key_derivation_test(
                L"Winter is coming.",
                _Make_salt("\x3E\xA2\xC4\x1A\xEB\x26\x12\x4C\xD9\xBC\x75\xCE\xF6\x35\x83\x2D"),
                "\xD3\xF6\x25\x07\x2B\x56\x49\xD7\xDF\x05\x06\x49\x8A\x11\xDB\x87"
                "\x60\xC7\xA3\x5C\x7B\xD0\x30\xC3\x70\x95\x38\x34\x56\x43\xB5\xD9"
            );
            _Run_key_derivation_test(
                L"Keep calm and carry on.",
                _Make_salt("\x87\xBF\x5B\x24\xB9\x83\x0A\x82\x2C\xBF\xDF\xAD\xFB\x49\xC5\x3D"),
                "\x58\xED\x99\xDA\x14\x64\x13\x9B\xE3\x71\x17\xA4\xCB\x84\x9A\xCF"
                "\x2A\x89\x5E\xE2\x5F\x4E\x7C\xA6\x7B\xF7\x23\xB9\x80\xB1\x23\x3C"
            );
            _Run_key_derivation_test(
                L"Time waits for no one.",
                _Make_salt("\x87\x07\x42\x60\xB7\xFB\x94\x96\xDC\xD9\xD3\x29\xFA\xE6\x06\x2F"),
                "\xB1\x3A\x8E\xE1\x39\x1A\x32\xD5\xFF\x80\x90\x89\x59\xE4\x57\x2E"
                "\x4C\x75\x17\x32\x1D\x92\xB0\x8D\xA3\x1C\x08\x7E\x7F\xDA\x50\x56"
            );
            _Run_key_derivation_test(
                L"Knowledge is power.",
                _Make_salt("\xD5\xD9\x4C\xFB\xCC\x9D\xFB\x97\xB4\x52\x21\x06\x4A\xF3\x93\x6D"),
                "\x05\x59\x59\xA0\x10\x36\x96\x44\x7E\x5B\xD0\x1E\x4B\x87\xC0\x50"
                "\x3A\x12\x16\x39\xF4\x43\xDB\xF2\xF1\x66\x7C\x02\xB3\xF4\x46\x0C"
            );
        }

        TEST(key_derivation, unicode) {
            _Run_key_derivation_test(
                L"こんにちは、世界！",
                _Make_salt("\xD1\x72\x03\xBE\xF1\xD6\x94\x92\xD3\xCD\xCB\xC7\x86\x1C\x72\x1B"),
                "\x9E\x29\x18\x69\x49\xCC\x13\x9C\x92\xBB\xAA\xBD\x30\x10\xC1\x35"
                "\x0C\x23\xBB\x75\x0A\xB8\x03\x4F\x30\x86\x17\xD2\x39\xA8\x9B\xBD"
            );
            _Run_key_derivation_test(
                L"我爱编程。",
                _Make_salt("\x95\x83\x32\xE3\x74\x3C\xE0\x46\x53\xA4\x26\x8C\x95\x69\xE0\xB6"),
                "\x4E\x34\xFE\x88\xAC\x19\x29\x4C\xC5\x3E\xFF\xE5\xAD\x50\x9A\x64"
                "\xE4\xB9\x40\x36\x2E\x9E\x17\x0F\x05\x8A\x42\xFE\x62\x62\x97\xBA"
            );
            _Run_key_derivation_test(
                L"Bing은 검색 엔진입니다.",
                _Make_salt("\x29\xD8\xCA\xC9\xD3\x72\x77\x60\xC2\xEC\xB0\x2A\xF4\xB3\x78\x77"),
                "\x6E\x97\x40\x9D\xE3\xFA\xB8\x63\xCC\xA5\x35\x1B\xED\x5C\xD9\x37"
                "\x1F\x1A\x52\xCB\xCF\x99\xE9\x75\xDD\x12\x04\x94\xEF\x44\x54\xD4"
            );
            _Run_key_derivation_test(
                L"Python là một ngôn ngữ tuyệt vời.",
                _Make_salt("\x42\x45\xA0\xFF\xD9\xDE\xDC\xAE\xD6\x20\x81\x3F\xC8\xFC\xF2\xB7"),
                "\xDF\xD7\x16\xC6\x96\x4A\x49\x67\x8A\x27\xD8\x8D\xDE\x5E\x6D\xD6"
                "\xC9\x13\x31\xA2\x79\xC7\x7F\x42\x24\xAA\x79\xA8\xB1\x83\x42\x0B"
            );
            _Run_key_derivation_test(
                L"Солнце встает на востоке.",
                _Make_salt("\x0E\x21\xFB\xCD\x01\x0A\xF7\x57\xE7\xBB\x12\x04\xB2\xBB\x0E\xB2"),
                "\xBB\x77\x8B\xB3\x83\x19\x62\xE0\x67\xA2\xFD\x99\x0C\x21\x76\xCA"
                "\x11\x0A\x89\xEE\xD0\xAC\x13\x6F\xBF\x90\x48\x40\x9D\x59\xE4\x8E"
            );
            _Run_key_derivation_test(
                L"Ο χειμώνας πλησιάζει.",
                _Make_salt("\x7C\x70\x81\xEC\xA9\xB3\x66\xE1\x5E\x23\x8C\x58\x91\x36\xB0\x57"),
                "\x2E\x11\xD7\x54\x19\x2A\x4B\x72\x12\x7F\xCA\xB5\xAC\x3B\x66\x8C"
                "\xB4\x54\x14\xD6\x4E\xF0\x76\x5F\x4C\x56\x02\x4F\x62\x03\xB1\x30"
            );
            _Run_key_derivation_test(
                L"Mantén la calma y sigue adelante.",
                _Make_salt("\x2B\x5E\x0B\x7D\x1B\x56\xD5\x52\x76\x63\x8E\xF4\x16\x5B\xB1\x6C"),
                "\xDC\x96\xFE\xEA\xA0\x8F\x88\xA2\x75\x9F\xF0\xC5\xA8\x19\x30\x48"
                "\x5D\xD9\x07\x09\xCF\x53\xDB\xBE\x17\x4B\xF4\xD9\x5F\xA4\x86\xE5"
            );
            _Run_key_derivation_test(
                L"Tiden venter på ingen.",
                _Make_salt("\xA1\x9E\xF3\xA8\x30\xC7\x8B\xC2\xFE\xAA\x91\xC0\xAF\xA2\x71\x61"),
                "\xB2\x4B\x52\x0D\x35\x90\x04\x9D\x69\x2D\xEB\x50\x5F\xFC\xC7\xA0"
                "\x7E\x80\xDD\xA0\x1E\xA7\x9D\x43\x3A\x52\xD8\xE4\x1D\xD6\x92\xB8"
            );
            _Run_key_derivation_test(
                L"المعرفة قوة.",
                _Make_salt("\xD4\x26\x7B\x15\x38\xA1\x90\x86\x7A\xD9\xB9\xEF\xFE\xCF\xAF\x4C"),
                "\x07\xEC\x1B\x33\x48\x7A\xEF\xEA\x38\xCB\xFE\x10\x61\x97\x06\x02"
                "\x2F\x00\xB5\xE3\x60\xFD\x8D\xBF\xCB\xD3\x9D\x7C\x50\x0E\x15\xF9"
            );
            _Run_key_derivation_test(
                L"Il tempo è denaro.",
                _Make_salt("\x19\xCD\x59\x70\xAF\x02\xAC\x1C\x50\x26\x55\x58\x98\xF2\x38\x00"),
                "\xBA\xDD\xE4\xED\xC4\xBB\x9B\x21\x36\x58\xF8\xF1\xC7\x28\x87\xDA"
                "\x2C\xBB\x60\xE0\x0D\x33\x98\x22\x68\xEA\x1A\x17\xA2\x1E\x33\x49"
            );
        }
    } // namespace test
} // namespace mjx

#endif // _EFC_TEST_UNIT_KEY_DERIVATION_HPP_